# Migration Guide - Docker Configuration Update

This guide helps you migrate from the old Docker configuration to the new optimized setup.

## Overview

The Docker configuration has been completely rewritten with:
- Multi-stage builds for smaller images
- Production-ready docker-compose with resource limits
- Comprehensive testing and CI/CD
- Enhanced security and secrets management

## Pre-Migration Checklist

- [ ] Review changes in DOCKER_REWRITE_SUMMARY.md
- [ ] Backup your current deployment
- [ ] Note your current environment variables
- [ ] Document any custom configurations
- [ ] Plan for potential downtime (recommended: 5-10 minutes)

## Backup Current Setup

```bash
# 1. Stop current containers
docker-compose down

# 2. Backup everything
cd /path/to/infinite-server26
tar czf ../fortress-backup-$(date +%Y%m%d).tar.gz \
  data/ \
  secrets/ \
  .env \
  docker-compose.yml \
  Dockerfile

# 3. Export current environment
docker-compose config > docker-compose-old-rendered.yml
```

## Migration Steps

### Step 1: Update Repository

```bash
# Pull latest changes
git fetch origin
git checkout main
git pull origin main

# Or for a specific branch
git checkout copilot/rewrite-docker-configuration
git pull
```

### Step 2: Review Changes

```bash
# Compare old and new Dockerfile
diff Dockerfile.old Dockerfile | less

# Compare old and new docker-compose
diff docker-compose.old.yml docker-compose.yml | less

# Review new environment variables
diff .env.example .env
```

### Step 3: Update Secrets

The new configuration uses dedicated secret files:

```bash
# Create secrets directory if it doesn't exist
mkdir -p secrets

# Copy your existing secrets
# Option A: From environment variables
echo "$VAULT_MASTER_KEY" > secrets/vault_master_key.txt
echo "$RANCHER_PASSWORD" > secrets/rancher_password.txt

# Option B: From existing files
cp /path/to/old/vault_key.txt secrets/vault_master_key.txt
cp /path/to/old/rancher_pass.txt secrets/rancher_password.txt

# Secure permissions
chmod 600 secrets/*.txt
```

### Step 4: Update Environment File

```bash
# Review new variables in .env.example
cat .env.example

# Update your .env file with new variables
nano .env

# Required new variables:
# - BUILD_DATE (optional, auto-generated)
# - VCS_REF (optional, auto-generated)
# - VAULT_MASTER_KEY_FILE=./secrets/vault_master_key.txt
# - RANCHER_PASSWORD_FILE=./secrets/rancher_password.txt
```

### Step 5: Create Data Directories

```bash
# Create required directories
mkdir -p data/{fortress,vault,rancher}
mkdir -p logs/fortress

# Set permissions
chmod 755 data/
chown -R 1000:1000 data/
```

### Step 6: Validate Configuration

```bash
# Validate docker-compose syntax
docker compose config

# Should show no errors, only warnings about version (safe to ignore)
```

### Step 7: Rebuild Images

```bash
# Build new multi-stage image
docker build -t nato1000/infinite-server26:latest .

# Or use docker-compose build
docker compose build --no-cache
```

### Step 8: Deploy New Configuration

```bash
# Start services
docker compose up -d

# Monitor startup
docker compose logs -f

# Wait for health checks (up to 60 seconds)
watch docker compose ps
```

### Step 9: Verify Deployment

```bash
# Check health
curl http://localhost:8000/health

# Verify all services are healthy
docker compose ps

# Check logs for errors
docker compose logs fortress | grep -i error
docker compose logs rancher | grep -i error

# Run test script
./scripts/docker-test.sh
```

### Step 10: Restore Data (if needed)

If you need to restore from backup:

```bash
# Stop services
docker compose down

# Restore volumes
docker run --rm \
  -v infinite-fortress-data:/data \
  -v $(pwd):/backup \
  alpine sh -c "cd /data && tar xzf /backup/fortress-data-backup.tar.gz --strip 1"

# Start services
docker compose up -d
```

## Configuration Changes

### Dockerfile Changes

**Old:** Single-stage, ~500 lines
**New:** Multi-stage, ~380 lines (4 stages)

**Benefits:**
- Smaller image size (~30-40% reduction)
- Better security (non-root user)
- Faster rebuilds (layer caching)
- Built-in testing

### docker-compose.yml Changes

**Added:**
- Resource limits (CPU/memory)
- Logging configuration
- Dedicated network with subnet
- Health check dependencies
- Secrets management

**Changed:**
- Volume configuration (named volumes)
- Network mode (bridge instead of host)
- Service dependencies (proper ordering)

### Environment Variables

**New Required Variables:**
```bash
VAULT_MASTER_KEY_FILE=./secrets/vault_master_key.txt
RANCHER_PASSWORD_FILE=./secrets/rancher_password.txt
```

**Optional New Variables:**
```bash
BUILD_DATE=<auto-generated>
VCS_REF=<git-sha>
DOCKER_REGISTRY=docker.io
DOCKER_IMAGE=nato1000/infinite-server26
IMAGE_TAG=latest
```

See .env.example for complete list.

## Rollback Procedure

If you encounter issues:

```bash
# 1. Stop new containers
docker compose down

# 2. Restore old files
tar xzf ../fortress-backup-YYYYMMDD.tar.gz

# 3. Use old Dockerfile
mv Dockerfile Dockerfile.new
mv Dockerfile.old Dockerfile

# 4. Use old docker-compose
mv docker-compose.yml docker-compose.new.yml
mv docker-compose.old.yml docker-compose.yml

# 5. Restart with old configuration
docker-compose up -d

# 6. Verify
docker-compose ps
```

## Common Issues

### Issue: Health checks failing

**Cause:** Port 8000 not accessible
**Solution:**
```bash
# Check if service is running
docker compose exec fortress python3 /usr/local/bin/health-check.py 8000

# Check port mapping
docker port fortress-test

# Check firewall
sudo ufw allow 8000/tcp
```

### Issue: Permission denied on volumes

**Cause:** Wrong ownership
**Solution:**
```bash
sudo chown -R 1000:1000 data/
sudo chmod -R 755 data/
```

### Issue: Secrets not found

**Cause:** Missing secret files
**Solution:**
```bash
# Create secrets
echo "your_vault_key" > secrets/vault_master_key.txt
echo "your_rancher_pass" > secrets/rancher_password.txt
chmod 600 secrets/*.txt
```

### Issue: Network conflicts

**Cause:** Subnet already in use
**Solution:**
Edit docker-compose.yml and change subnet:
```yaml
networks:
  fortress-network:
    ipam:
      config:
        - subnet: 172.27.0.0/16  # Change this
          gateway: 172.27.0.1    # And this
```

### Issue: Build fails

**Cause:** Network or package issues
**Solution:**
```bash
# Retry with better DNS
echo 'nameserver 8.8.8.8' | sudo tee /etc/resolv.conf

# Or use cached build
docker compose build
```

## Testing Checklist

After migration, verify:

- [ ] All containers are running (`docker compose ps`)
- [ ] Health checks are passing (`curl http://localhost:8000/health`)
- [ ] Rancher is accessible (http://localhost:8090)
- [ ] Logs show no errors (`docker compose logs`)
- [ ] Data persists after restart
- [ ] Secrets are loaded correctly
- [ ] Network connectivity works
- [ ] Resource limits are in effect (`docker stats`)

## Performance Comparison

**Build Time:**
- Old: ~20-30 minutes (full build)
- New: ~15-20 minutes (first build), ~5-10 minutes (cached)

**Image Size:**
- Old: ~3-5 GB (estimated)
- New: ~2-3 GB (multi-stage optimized)

**Memory Usage:**
- Old: Unlimited
- New: 8GB limit for fortress, 4GB for rancher

## Support

If you encounter issues during migration:

1. Check logs: `docker compose logs`
2. Review documentation: `DOCKER.md`, `DOCKER_REWRITE_SUMMARY.md`
3. Run test script: `./scripts/docker-test.sh`
4. Check GitHub Issues
5. Rollback if necessary (see above)

## Post-Migration Tasks

- [ ] Update CI/CD pipelines (if any)
- [ ] Update monitoring/alerting (new resource limits)
- [ ] Update backup scripts (new paths)
- [ ] Document any custom changes
- [ ] Test failover procedures
- [ ] Schedule regular security scans

## Next Steps

1. **Monitor Performance:** Track resource usage over first 24-48 hours
2. **Adjust Limits:** Fine-tune CPU/memory based on actual usage
3. **Enable CI/CD:** Push to main to trigger automated builds
4. **Security Scan:** Review Trivy results in GitHub Security tab
5. **Backup Schedule:** Set up automated backups (see DOCKER.md)

## Additional Resources

- [DOCKER.md](DOCKER.md) - Complete Docker documentation
- [DOCKER_QUICKREF.md](DOCKER_QUICKREF.md) - Quick command reference
- [DOCKER_REWRITE_SUMMARY.md](DOCKER_REWRITE_SUMMARY.md) - Detailed change summary
- [README.md](README.md) - Project overview
- [.env.example](.env.example) - Environment variable template

---

**Migration Support:** If you need assistance, open an issue on GitHub with:
- Current setup details
- Error messages
- Logs from failed deployment
- Output of `docker compose config`

**Emergency Contact:** For critical production issues, tag @NaTo1000 in GitHub issues.
