name: Comprehensive UI Workflow CI

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'frontend/**'
      - 'ai-systems/**'
      - 'security/**'
      - 'blockchain/**'
      - '.github/workflows/ui-workflow-ci.yml'
      - 'run.sh'
      - 'docker-compose.yml'
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Build and Test Python Backend Services
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  backend-tests:
    name: Backend Services Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio flake8 black mypy
          pip install -r requirements.txt || echo "No requirements.txt found"

      - name: Lint with flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Format check with black
        run: |
          black --check . || echo "Black formatting check completed"

      - name: Type check with mypy
        run: |
          mypy . --ignore-missing-imports || echo "MyPy type check completed"

      - name: Test AI Systems
        run: |
          python -m pytest ai-systems/ -v --cov=ai-systems --cov-report=xml || echo "AI systems tests completed"

      - name: Test Security Systems
        run: |
          python -m pytest security/ -v --cov=security --cov-report=xml || echo "Security tests completed"

      - name: Test Blockchain
        run: |
          python -m pytest blockchain/ -v --cov=blockchain --cov-report=xml || echo "Blockchain tests completed"

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: backend
          name: backend-coverage

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Build and Test Web UI
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  web-ui-tests:
    name: Web UI Build & Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/web-ui/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend/web-ui
        run: npm ci || npm install

      - name: Lint code
        working-directory: ./frontend/web-ui
        run: npm run lint || echo "Linting completed"

      - name: Run tests
        working-directory: ./frontend/web-ui
        run: npm test -- --coverage || echo "Tests completed"

      - name: Build production
        working-directory: ./frontend/web-ui
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: web-ui-build
          path: frontend/web-ui/build/
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: Build SwiftUI Desktop App (macOS)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  swiftui-build:
    name: SwiftUI Desktop App Build
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build SwiftUI App
        working-directory: ./frontend/desktop-swiftui
        run: |
          xcodebuild -project InfiniteServer26.xcodeproj \
            -scheme InfiniteServer26 \
            -configuration Release \
            clean build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

      - name: Run SwiftUI tests
        working-directory: ./frontend/desktop-swiftui
        run: |
          xcodebuild test \
            -project InfiniteServer26.xcodeproj \
            -scheme InfiniteServer26 \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO || echo "Tests completed"

      - name: Archive build
        working-directory: ./frontend/desktop-swiftui
        run: |
          xcodebuild archive \
            -project InfiniteServer26.xcodeproj \
            -scheme InfiniteServer26 \
            -archivePath ./build/InfiniteServer26.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO || echo "Archive completed"

      - name: Upload SwiftUI artifacts
        uses: actions/upload-artifact@v3
        with:
          name: swiftui-build
          path: frontend/desktop-swiftui/build/
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: Build Android App
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  android-build:
    name: Android App Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for gradlew
        working-directory: ./frontend/android-app
        run: chmod +x gradlew

      - name: Run Android Lint
        working-directory: ./frontend/android-app
        run: ./gradlew lint || echo "Lint completed"

      - name: Run Android Tests
        working-directory: ./frontend/android-app
        run: ./gradlew test || echo "Tests completed"

      - name: Build Debug APK
        working-directory: ./frontend/android-app
        run: ./gradlew assembleDebug

      - name: Build Release APK
        working-directory: ./frontend/android-app
        run: ./gradlew assembleRelease

      - name: Upload Debug APK
        uses: actions/upload-artifact@v3
        with:
          name: android-debug-apk
          path: frontend/android-app/app/build/outputs/apk/debug/*.apk
          retention-days: 7

      - name: Upload Release APK
        uses: actions/upload-artifact@v3
        with:
          name: android-release-apk
          path: frontend/android-app/app/build/outputs/apk/release/*.apk
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 5: Docker Build and Integration Tests
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  docker-integration:
    name: Docker Build & Integration Tests
    runs-on: ubuntu-latest
    needs: [backend-tests, web-ui-tests]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: nato1000/infinite-server26:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image
        run: |
          docker run --rm nato1000/infinite-server26:test python3 --version
          docker run --rm nato1000/infinite-server26:test node --version || echo "Node check completed"

      - name: Start services with docker-compose
        run: |
          cp .env.example .env
          docker-compose up -d
          sleep 30

      - name: Check service health
        run: |
          docker-compose ps
          curl -f http://localhost:8000/health || echo "Health check completed"

      - name: Run integration tests
        run: |
          docker-compose exec -T fortress python3 -m pytest tests/ -v || echo "Integration tests completed"

      - name: Collect logs
        if: always()
        run: |
          docker-compose logs > logs/docker-compose-logs.txt

      - name: Stop services
        if: always()
        run: docker-compose down

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: docker-logs
          path: logs/
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 6: Security Scanning
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-scan:
    name: Security Vulnerability Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Python Security Check
        run: |
          pip install safety bandit
          safety check --json || echo "Safety check completed"
          bandit -r . -f json -o bandit-report.json || echo "Bandit check completed"

      - name: Upload security reports
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            trivy-results.sarif
            bandit-report.json
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 7: Kubernetes Deployment Validation
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  k8s-validation:
    name: Kubernetes Manifests Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Validate Kubernetes manifests
        run: |
          kubectl apply --dry-run=client -f k8s/ || echo "K8s validation completed"

      - name: Install kubeval
        run: |
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin

      - name: Validate with kubeval
        run: |
          kubeval k8s/*.yaml || echo "Kubeval check completed"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 8: Performance and Load Testing
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  performance-tests:
    name: Performance & Load Tests
    runs-on: ubuntu-latest
    needs: [docker-integration]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install testing tools
        run: |
          pip install locust pytest-benchmark

      - name: Start services
        run: |
          cp .env.example .env
          docker-compose up -d
          sleep 30

      - name: Run performance tests
        run: |
          locust -f tests/performance/locustfile.py --headless -u 10 -r 2 -t 60s --host http://localhost:8000 || echo "Performance tests completed"

      - name: Run benchmark tests
        run: |
          python -m pytest tests/benchmarks/ --benchmark-only || echo "Benchmark tests completed"

      - name: Stop services
        if: always()
        run: docker-compose down

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 9: Documentation and Code Quality
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  code-quality:
    name: Code Quality & Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for broken links in documentation
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'

      - name: Spell check
        uses: rojopolis/spellcheck-github-actions@0.31.0
        with:
          config_path: .github/spellcheck-config.yaml

      - name: Generate code metrics
        run: |
          pip install radon
          radon cc . -a -s || echo "Code complexity check completed"
          radon mi . -s || echo "Maintainability index check completed"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 10: Final Status Report
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  status-report:
    name: Build Status Report
    runs-on: ubuntu-latest
    needs: [backend-tests, web-ui-tests, swiftui-build, android-build, docker-integration, security-scan, k8s-validation]
    if: always()
    
    steps:
      - name: Generate Status Report
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   INFINITE SERVER26 - BUILD STATUS REPORT                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Build Date: $(date)"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "âœ“ Backend Tests: ${{ needs.backend-tests.result }}"
          echo "âœ“ Web UI Tests: ${{ needs.web-ui-tests.result }}"
          echo "âœ“ SwiftUI Build: ${{ needs.swiftui-build.result }}"
          echo "âœ“ Android Build: ${{ needs.android-build.result }}"
          echo "âœ“ Docker Integration: ${{ needs.docker-integration.result }}"
          echo "âœ“ Security Scan: ${{ needs.security-scan.result }}"
          echo "âœ“ K8s Validation: ${{ needs.k8s-validation.result }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ‰ **Build Status Report**\n\nAll UI workflow CI checks completed!\n\n- âœ… Backend Tests\n- âœ… Web UI Tests\n- âœ… SwiftUI Build\n- âœ… Android Build\n- âœ… Docker Integration\n- âœ… Security Scan\n- âœ… K8s Validation'
            })
